{
  "version": 3,
  "sources": ["../logger.ts"],
  "sourcesContent": ["/* eslint-disable no-console */\r\nimport errorStackParser from \"error-stack-parser\";\r\nimport StackFrame from \"stackframe\";\r\nimport { RC_Config } from \"./shared-types.js\";\r\n\r\nconst startTime = Date.now();\r\n\r\nexport const colorize = (light: number, code: number) => (str: string) =>\r\n  \"\\x1B[\" + light + \";\" + code + \"m\" + str + \"\\x1b[0m\";\r\nexport const blue = colorize(1, 34);\r\nexport const red = colorize(1, 31);\r\nexport const yellow = colorize(1, 33);\r\nexport const grey = colorize(0, 37);\r\nexport const green = colorize(1, 37);\r\nexport const cyan = colorize(1, 36);\r\n\r\nconst emojiFontCss =\r\n  'font-family: Roboto, \"Apple Color Emoji\", NotoEmoji, \"Helvetica Neue\", Arial, Helvetica, NotoMono, sans-serif !important;';\r\n\r\nexport const enum LogLevelString {\r\n  DEBUG = \"DEBUG\",\r\n  WARNING = \"WARNING\",\r\n  INFO = \"INFO\",\r\n  ERROR = \"ERROR\",\r\n  CRITICAL = \"CRITICAL\",\r\n}\r\n\r\nconst LoggerVariants = [\r\n  {\r\n    log: console.debug,\r\n    level: LogLevelString.DEBUG,\r\n    emoji: \"\uD83D\uDD78\uFE0F\",\r\n    symbol: \"[D]\",\r\n  },\r\n  {\r\n    log: console.info,\r\n    level: LogLevelString.INFO,\r\n    emoji: \"\u2139\uFE0F\",\r\n    symbol: blue(\"[i]\"),\r\n  },\r\n  {\r\n    log: console.warn,\r\n    level: LogLevelString.WARNING,\r\n    emoji: \"\u26A0\uFE0F\",\r\n    symbol: yellow(\"[w]\"),\r\n  },\r\n  {\r\n    log: console.error,\r\n    level: LogLevelString.ERROR,\r\n    emoji: \"\uD83D\uDEA8\",\r\n    symbol: red(\"[E]\"),\r\n  },\r\n  {\r\n    log: console.error,\r\n    level: LogLevelString.CRITICAL,\r\n    emoji: \"\uD83D\uDEA8\uD83D\uDEA8\",\r\n    symbol: red(\"[C]\"),\r\n  },\r\n];\r\n\r\nexport function printProcessLogLevelInfo() {\r\n  /* ignore-console-log */\r\n  console.info(\r\n    `%cLogging Levels:\\n${LoggerVariants.map(\r\n      (v) => `${v.emoji} ${v.level}`,\r\n    ).join(\"\\n\")}`,\r\n    emojiFontCss,\r\n  );\r\n  /* ignore-console-log */\r\n  console.info(\r\n    `# Tips and Tricks for using the search filter in the browser console:\r\n\r\n\u2022 Use space to separate search terms\r\n\u2022 Exclude search terms using -\r\n\u2022 If the search term contains spaces you should escape it with \"\"\r\n\r\nExamples:\r\n\r\n\uD83D\uDD78\uFE0F          only show debug messages\r\n-\uD83D\uDD78\uFE0F         don't show debug messages\r\n\u2139\uFE0F          only show info messages\r\n-\u2139\uFE0F         don't show info messages\r\n\uD83D\uDC7B          only show events from background accounts (not selected accounts)\r\n-\uD83D\uDC7B         don't show events from background accounts (not selected accounts)\r\n\uD83D\uDCE1          only show events\r\n-\uD83D\uDCE1         don't show any events\r\n[JSONRPC]   only show jsonrpc messages\r\n-[JSONRPC]  don't show jsonrpc messages\r\n\r\nStart deltachat with --devmode (or --log-debug and --log-to-console) argument to show full log output.\r\nIf the log seems quiet, make sure the 'All levels' drop down has 'Verbose' checked.\r\n  `,\r\n  );\r\n}\r\n\r\nexport type LogHandlerFunction = (\r\n  channel: string,\r\n  level: LogLevelString,\r\n  stacktrace: ReturnType<typeof getStackTrace>,\r\n  ...args: any[]\r\n) => void;\r\n\r\nlet handler: LogHandlerFunction;\r\nlet rc: RC_Config = {} as any;\r\n\r\nexport function setLogHandler(\r\n  LogHandler: LogHandlerFunction,\r\n  rcObject: RC_Config,\r\n) {\r\n  handler = LogHandler;\r\n  rc = rcObject;\r\n}\r\n\r\nfunction log(\r\n  { channel, isMainProcess }: Logger,\r\n  level: number,\r\n  stacktrace: ReturnType<typeof getStackTrace>,\r\n  args: any[],\r\n) {\r\n  const variant = LoggerVariants[level];\r\n  if (!handler) {\r\n    // Handler not initialized yet - just log to console and return\r\n    // This can happen during module initialization before runtime.initialize() is called\r\n    /* ignore-console-log */\r\n    variant.log(`[early] ${channel}:`, ...args);\r\n    return; // Don't throw - just gracefully continue\r\n  }\r\n  handler(channel, variant.level, stacktrace, ...args);\r\n  if (rc[\"log-to-console\"]) {\r\n    if (isMainProcess) {\r\n      const beginning = `${Math.round((Date.now() - startTime) / 100) / 10}s ${\r\n        LoggerVariants[level].symbol\r\n      }${grey(channel)}:`;\r\n      if (!stacktrace) {\r\n        variant.log(beginning, ...args);\r\n      } else {\r\n        variant.log(\r\n          beginning,\r\n          ...args,\r\n          red(\r\n            Array.isArray(stacktrace)\r\n              ? stacktrace.map((s) => `\\n${s.toString()}`).join()\r\n              : stacktrace,\r\n          ),\r\n        );\r\n      }\r\n    } else {\r\n      const prefix = `%c${variant.emoji}%c${channel}`;\r\n      const prefixStyle = [emojiFontCss, \"color:blueviolet;\"];\r\n\r\n      if (stacktrace) {\r\n        variant.log(prefix, ...prefixStyle, stacktrace, ...args);\r\n      } else {\r\n        variant.log(prefix, ...prefixStyle, ...args);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction getStackTrace(): StackFrame[] | string {\r\n  const rawStack: StackFrame[] = errorStackParser.parse(\r\n    new Error(\"Get Stacktrace\"),\r\n  );\r\n  const stack = rawStack.slice(2, rawStack.length);\r\n  return rc[\"machine-readable-stacktrace\"]\r\n    ? stack\r\n    : stack.map((s) => `\\n${s.toString()}`).join();\r\n}\r\n\r\nexport class Logger {\r\n  //@ts-ignore\r\n  isMainProcess = typeof window === \"undefined\";\r\n  constructor(public readonly channel: string) {\r\n    if (channel === \"core/event\") {\r\n      // disable js stacktrace for core events\r\n      // as it is useless information (always pointing to the event emitter)\r\n      this.getStackTrace = () => \"\";\r\n    }\r\n  }\r\n\r\n  private getStackTrace(): StackFrame[] | string {\r\n    const rawStack: StackFrame[] = errorStackParser.parse(\r\n      new Error(\"Get Stacktrace\"),\r\n    );\r\n    const stack = rawStack.slice(2, rawStack.length);\r\n    return rc[\"machine-readable-stacktrace\"]\r\n      ? stack\r\n      : stack.map((s) => `\\n${s.toString()}`).join();\r\n  }\r\n\r\n  debug(...args: any[]) {\r\n    if (!rc[\"log-debug\"]) return;\r\n    log(this, 0, \"\", args);\r\n  }\r\n\r\n  info(...args: any[]) {\r\n    log(this, 1, \"\", args);\r\n  }\r\n\r\n  warn(...args: any[]) {\r\n    log(this, 2, this.getStackTrace(), args);\r\n  }\r\n\r\n  error(...args: any[]) {\r\n    log(this, 3, this.getStackTrace(), args);\r\n  }\r\n\r\n  /** use this when you know that the stacktrace is not relevant */\r\n  errorWithoutStackTrace(...args: any[]) {\r\n    log(this, 3, [], args);\r\n  }\r\n\r\n  critical(...args: any[]) {\r\n    log(this, 4, this.getStackTrace(), args);\r\n  }\r\n}\r\n\r\nexport function getLogger(channel: string) {\r\n  return new Logger(channel);\r\n}\r\n\r\n// Fix for error not being able to be converted into json\r\n// From https://stackoverflow.com/a/18391400\r\nif (!(\"toJSON\" in Error.prototype))\r\n  Object.defineProperty(Error.prototype, \"toJSON\", {\r\n    value: function () {\r\n      const alt = {};\r\n      Object.getOwnPropertyNames(this).forEach(function (key) {\r\n        //@ts-ignore\r\n        alt[key] = this[key];\r\n      }, this);\r\n      return alt;\r\n    },\r\n    configurable: true,\r\n    writable: true,\r\n  });\r\n"],
  "mappings": "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",
  "names": ["LogLevelString"]
}
