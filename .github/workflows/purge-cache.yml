name: Purge Cache & Dependencies

on:
  workflow_dispatch:
    inputs:
      clear_pnpm_cache:
        description: 'Clear pnpm cache'
        required: true
        default: true
        type: boolean
      clear_actions_cache:
        description: 'Clear GitHub Actions cache'
        required: true
        default: true
        type: boolean
      trigger_fresh_build:
        description: 'Trigger fresh CI build after purge'
        required: true
        default: true
        type: boolean

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clear GitHub Actions Cache
      if: ${{ inputs.clear_actions_cache }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ—‘ï¸ Clearing GitHub Actions cache..."
        # List all caches
        CACHES=$(gh cache list --json id,key --jq '.[].id' 2>/dev/null || echo "")
        if [ -n "$CACHES" ]; then
          echo "Found caches to delete:"
          gh cache list
          # Delete each cache
          for cache_id in $CACHES; do
            echo "Deleting cache: $cache_id"
            gh cache delete "$cache_id" || true
          done
          echo "âœ… All caches cleared"
        else
          echo "â„¹ï¸ No caches found to clear"
        fi

    - name: Install pnpm
      if: ${{ inputs.clear_pnpm_cache }}
      uses: pnpm/action-setup@v4

    - name: Clear pnpm store
      if: ${{ inputs.clear_pnpm_cache }}
      run: |
        echo "ğŸ—‘ï¸ Clearing pnpm store..."
        pnpm store prune
        echo "âœ… pnpm store pruned"

    - name: Summary
      run: |
        echo "## Cache Purge Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Action | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Clear Actions Cache | ${{ inputs.clear_actions_cache && 'âœ… Done' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Clear pnpm Cache | ${{ inputs.clear_pnpm_cache && 'âœ… Done' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger Fresh Build | ${{ inputs.trigger_fresh_build && 'ğŸ”„ Pending' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  trigger-fresh-build:
    needs: purge-cache
    if: ${{ inputs.trigger_fresh_build }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: Trigger CI22 workflow
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ”„ Triggering fresh CI22 build..."
        gh workflow run ci22.yml --repo ${{ github.repository }} --ref main
        echo "âœ… CI22 workflow triggered"

    - name: Trigger Cloudflare deployment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ”„ Triggering Cloudflare deployment..."
        gh workflow run deploy-cloudflare.yml --repo ${{ github.repository }} --ref main || echo "âš ï¸ deploy-cloudflare.yml may not have workflow_dispatch trigger"
        echo "âœ… Deployment workflow triggered (if available)"
