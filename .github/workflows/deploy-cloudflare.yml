name: Deploy to Cloudflare Containers

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - production

# Ensure only one deployment runs at a time per branch
concurrency:
  group: cloudflare-${{ github.ref }}
  cancel-in-progress: true

env:
  WRANGLER_VERSION: "4"

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: "pnpm"  # Disabled for fresh builds

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Browser Target
        run: pnpm build:browser

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Wrangler
        run: pnpm add -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: Deploy to Cloudflare Containers
        id: deploy
        # Run from repo root so Dockerfile.cloudflare is accessible
        working-directory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Deploy with Wrangler using immediate rollout to avoid gradual rollout JSON parsing issues
          set +e  # Don't exit on error so we can capture output
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Preview deployment for PRs
            wrangler deploy --config packages/target-browser/wrangler.jsonc --env preview --containers-rollout=immediate 2>&1 | tee /tmp/deploy_output.txt
            DEPLOY_STATUS=${PIPESTATUS[0]}
          else
            # Production deployment for main branch
            wrangler deploy --config packages/target-browser/wrangler.jsonc --containers-rollout=immediate 2>&1 | tee /tmp/deploy_output.txt
            DEPLOY_STATUS=${PIPESTATUS[0]}
          fi
          
          # Extract the Cloudflare Workers deployment URL (format: https://*.workers.dev)
          # This specifically matches the workers.dev URL, not other URLs in the output
          DEPLOY_URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.workers\.dev' /tmp/deploy_output.txt | head -1 || true)
          
          # If no workers.dev URL found, try the d-*.workers.dev pattern
          if [ -z "$DEPLOY_URL" ]; then
            DEPLOY_URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.workers\.dev' /tmp/deploy_output.txt | head -1 || true)
          fi
          
          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "Extracted deployment URL: $DEPLOY_URL"
          
          # Show full output for debugging
          echo "=== Full Wrangler Output ==="
          cat /tmp/deploy_output.txt
          
          # Exit with the original status
          exit $DEPLOY_STATUS

      - name: Comment PR with Preview URL
        if: github.event_name == 'pull_request' && steps.deploy.outputs.deployment_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';
            if (deploymentUrl) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸš€ Preview Deployment Ready!\n\n**URL:** ${deploymentUrl}\n\n> This preview will be available for 30 minutes of inactivity before sleeping. The first request after sleep may take a few seconds to wake up the container.`
              });
            }

      - name: Log Deployment Info
        if: always()
        run: |
          echo "Deployment URL: ${{ steps.deploy.outputs.deployment_url }}"
          echo "Job Status: ${{ job.status }}"
          echo "Event Name: ${{ github.event_name }}"
